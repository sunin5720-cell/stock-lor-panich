<!doctype html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ - ‚≠ê ‡∏•‡πâ‡∏≠‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå ‚≠ê</title>

  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- Tailwind (optional) -->
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>

  <style>
    /* (CSS ‡∏¢‡∏≤‡∏ß‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö) */
    /* ---------- ‡πÄ‡∏£‡∏¥‡πà‡∏° CSS ---------- */
    body { box-sizing: border-box; margin:0; padding:0; font-family: 'Sarabun', 'Noto Sans Thai', -apple-system, BlinkMacSystemFont, sans-serif; background: linear-gradient(135deg,#ffc3e1 0%,#ffe5f0 100%); min-height:100%; height:100%; }
    html{height:100%} *{box-sizing:border-box}
    @keyframes fadeInSlideDown{from{opacity:0;transform:translateY(-20px)}to{opacity:1;transform:translateY(0)}}
    @keyframes fadeInSlideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    @keyframes modalFadeIn{from{opacity:0}to{opacity:1}}
    @keyframes modalImageZoom{from{opacity:0;transform:scale(0.9)}to{opacity:1;transform:scale(1)}}
    .container{max-width:1200px;margin:0 auto;padding:20px}
    .header{background:linear-gradient(180deg,rgba(255,255,255,0.3) 0%,rgba(255,255,255,0)20%),linear-gradient(135deg,#ff69b4 0%,#ff1493 30%,#c71585 60%,#ff1493 80%,#ff69b4 100%);border-radius:25px;padding:45px 30px 40px 30px;margin-bottom:20px;box-shadow:0 8px 35px rgba(255,105,180,0.5),0 2px 15px rgba(255,255,255,0.2) inset;text-align:center;animation:fadeInSlideUp .6s ease-out;position:relative;overflow:hidden}
    .header::before{content:'';position:absolute;top:20px;left:30px;width:50px;height:50px;opacity:.15;animation:fadeInSlideDown 1.2s ease-out;background-image:url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>');background-size:contain;background-repeat:no-repeat}
    .header::after{content:'';position:absolute;top:20px;right:30px;width:50px;height:50px;opacity:.15;animation:fadeInSlideDown 1.4s ease-out;background-image:url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>');background-size:contain;background-repeat:no-repeat}
    .header h1{margin:0 0 15px 0;color:#fff;font-size:36px;font-weight:700;text-shadow:0 2px 8px rgba(0,0,0,.2),0 4px 15px rgba(255,255,255,.3);animation:fadeInSlideDown .8s;font-family:'Sarabun','Noto Sans Thai',sans-serif}
    .shop-badge{display:inline-block;margin:0 0 20px 0;padding:12px 35px;background:linear-gradient(135deg,rgba(255,255,255,.3)0%,rgba(255,255,255,.15)100%);backdrop-filter:blur(15px);border:2px solid rgba(255,255,255,.6);border-radius:50px;color:#ffd700;font-size:26px;font-weight:700;letter-spacing:3px;text-shadow:0 2px 8px rgba(0,0,0,.3);box-shadow:0 6px 20px rgba(0,0,0,.2),0 2px 8px rgba(255,255,255,.3) inset;animation:fadeInSlideDown 1s;position:relative;overflow:hidden;font-family:'Sarabun','Noto Sans Thai',sans-serif}
    .controls-card{background:#fff;border-radius:20px;padding:25px;margin-bottom:20px;box-shadow:0 4px 20px rgba(255,105,180,.15);animation:fadeInSlideUp .8s;transition:box-shadow .3s,transform .3s}
    .search-filter-row{display:flex;gap:15px;flex-wrap:wrap;align-items:center;justify-content:center}
    .search-box{flex:1;min-width:300px;max-width:600px}
    .search-box input{width:100%;padding:14px 20px;border:2px solid #ffc3e1;border-radius:15px;font-size:16px;outline:none;transition:all .3s}
    .filter-select{padding:14px 25px;border:2px solid #ffc3e1;border-radius:15px;background:#fff;color:#ff69b4;font-size:16px;font-weight:600;cursor:pointer;min-width:220px}
    .admin-btn{padding:14px 40px;border:2px solid rgba(255,255,255,.6);border-radius:30px;background:linear-gradient(135deg,rgba(255,255,255,.3)0%,rgba(255,255,255,.15)100%);color:#fff;font-size:17px;font-weight:700;cursor:pointer}
    .table-card{background:#fff;border-radius:20px;padding:25px;box-shadow:0 4px 20px rgba(255,105,180,.15);overflow-x:auto}
    thead th{background:#ff1493;color:#fff;padding:15px;text-align:left;font-weight:700;font-size:16px;white-space:nowrap}
    tbody td{padding:15px;color:#333;font-size:15px}
    .product-image{width:64px;height:64px;object-fit:cover;border-radius:10px;cursor:pointer;border:2px solid #ffe5f0}
    .status-badge{display:inline-flex;align-items:center;gap:6px;padding:8px 18px;border-radius:50px;font-size:14px;font-weight:700;white-space:nowrap}
    .status-ready{background:linear-gradient(135deg,#b3e5fc 0%,#c8e6c9 100%);color:#1b5e20}
    .status-out{background:linear-gradient(135deg,#e1bee7 0%,#f8bbd0 100%);color:#6a1b9a}
    .status-warehouse{background:linear-gradient(135deg,#fff9c4 0%,#ffccbc 100%);color:#e65100}
    .status-shipping{background:linear-gradient(135deg,#b3e5fc 0%,#d1c4e9 100%);color:#4527a0}
    .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.7);align-items:center;justify-content:center}
    .modal.active{display:flex;animation:modalFadeIn .3s}
    .modal-content{background:#fff;padding:30px;border-radius:20px;max-width:90%;max-height:90%;text-align:center;animation:modalImageZoom .4s}
    .modal-content img{max-width:100%;max-height:70%;border-radius:15px}
    .modal-close{margin-top:20px;padding:10px 30px;border:none;border-radius:15px;background:#ff69b4;color:#fff;cursor:pointer}
    .last-updated{text-align:center;margin:20px auto 0;padding:12px 24px;background:linear-gradient(135deg,#fff0f7 0%,#ffe5f0 100%);border-radius:16px;color:#ff69b4;font-weight:600;display:table}
    /* responsive and dark mode omitted here for brevity; keep original css block in your file */
    /* ---------- ‡∏à‡∏ö CSS (‡πÉ‡∏ä‡πâ CSS ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏£‡∏¥‡∏á‡πÄ‡∏ï‡πá‡∏°‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ) ---------- */
  </style>
</head>
<body>
  <!-- Viewer Section -->
  <div id="viewerSection">
    <div class="container">
      <div class="header">
        <button class="theme-toggle-btn" id="themeToggleViewer" aria-label="Toggle Dark Mode">
          <span class="theme-icon">üåô</span>
          <span class="theme-text">Dark</span>
        </button>
        <h1 id="pageTitle">‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡∏π‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h1>
        <div class="shop-badge" id="shopName">‚≠ê ‡∏•‡πâ‡∏≠‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå ‚≠ê</div>
        <div>
          <button class="admin-btn" id="goToAdminBtn">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Admin</button>
          <p class="header-subtitle">‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
        </div>
      </div>

      <div class="controls-card">
        <div class="search-filter-row">
          <div class="search-box">
            <input type="text" id="searchInput" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤..." />
          </div>
          <div class="filter-group">
            <select class="filter-select" id="statusFilterSelect">
              <option value="all">üìã ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
              <option value="‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á">‚úÖ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á</option>
              <option value="‡∏´‡∏°‡∏î">‚ö†Ô∏è ‡∏´‡∏°‡∏î</option>
              <option value="‡∏≠‡∏¢‡∏π‡πà‡πÇ‡∏Å‡∏î‡∏±‡∏á‡πÑ‡∏ó‡∏¢">üì¶ ‡∏≠‡∏¢‡∏π‡πà‡πÇ‡∏Å‡∏î‡∏±‡∏á‡πÑ‡∏ó‡∏¢</option>
              <option value="‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á">üöö ‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</option>
            </select>
          </div>
        </div>
      </div>

      <div class="table-card">
        <table>
          <thead>
            <tr>
              <th>üñºÔ∏è ‡∏£‡∏π‡∏õ</th>
              <th>üè∑Ô∏è ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
              <th>üì¶ ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
              <th>üî¢ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
              <th>‚ú® ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
            </tr>
          </thead>
          <tbody id="viewerTableBody">
            <tr>
              <td colspan="5" style="text-align:center;padding:40px;color:#999;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td>
            </tr>
          </tbody>
        </table>

        <div id="viewerPagination" style="display:none;justify-content:center;align-items:center;gap:15px;margin-top:20px;padding-top:20px;border-top:2px solid #ffe5f0;">
          <button id="prevPageBtn" class="action-btn edit-btn" style="margin:0;">‚óÄ ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
          <span id="pageInfo" style="color:#ff69b4;font-weight:600;font-size:16px;">‡∏´‡∏ô‡πâ‡∏≤ 1 / 1</span>
          <button id="nextPageBtn" class="action-btn edit-btn" style="margin:0;">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚ñ∂</button>
        </div>

        <div id="lastUpdatedViewer" class="last-updated"></div>
      </div>
    </div>
  </div>

  <!-- Login Section -->
  <div class="login-container" id="loginSection" style="display:none;">
    <div class="login-card">
      <h2>üîê ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Admin</h2>
      <form id="loginForm">
        <div class="form-group"><label for="adminId">Admin ID</label><input type="text" id="adminId" required /></div>
        <div class="form-group"><label for="adminPassword">Password</label><input type="password" id="adminPassword" required /></div>
        <button type="submit" class="login-btn">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        <button type="button" class="back-btn" id="backToViewerBtn">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
      </form>
    </div>
  </div>

  <!-- Admin Section -->
  <div class="admin-container" id="adminSection" style="display:none;">
    <div class="container">
      <div class="header">
        <button class="theme-toggle-btn" id="themeToggleAdmin" aria-label="Toggle Dark Mode">
          <span class="theme-icon">üåô</span>
          <span class="theme-text">Dark</span>
        </button>

        <div class="admin-header" style="display:flex;width:100%;justify-content:space-between;align-items:center;">
          <div>
            <h1 id="adminPageTitle">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h1>
            <div class="shop-badge" id="adminShopName">‚≠ê ‡∏•‡πâ‡∏≠‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå ‚≠ê</div>
          </div>
          <button class="logout-btn" id="logoutBtn">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
      </div>

      <div class="form-card" id="addProductCard" style="display:none;">
        <h3>‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</h3>
        <form id="addProductForm">
          <div class="form-row">
            <div class="form-group"><label for="addSku">‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ *</label><input type="text" id="addSku" required /></div>
            <div class="form-group"><label for="addName">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ *</label><input type="text" id="addName" required /></div>
            <div class="form-group"><label for="addQuantity">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ *</label><input type="number" id="addQuantity" min="0" value="0" required /></div>
          </div>

          <div class="form-row">
            <div class="form-group"><label for="addStatus">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ *</label>
              <select id="addStatus" required>
                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ --</option>
                <option value="‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á">‚úÖ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á</option>
                <option value="‡∏´‡∏°‡∏î">‚ö†Ô∏è ‡∏´‡∏°‡∏î</option>
                <option value="‡∏≠‡∏¢‡∏π‡πà‡πÇ‡∏Å‡∏î‡∏±‡∏á‡πÑ‡∏ó‡∏¢">üì¶ ‡∏≠‡∏¢‡∏π‡πà‡πÇ‡∏Å‡∏î‡∏±‡∏á‡πÑ‡∏ó‡∏¢</option>
                <option value="‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á">üöö ‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</option>
              </select>
            </div>
            <div class="form-group"><label for="addImageUrl">‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ *</label>
              <input type="url" id="addImageUrl" placeholder="‡∏ß‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå Google Drive ‡πÅ‡∏ö‡∏ö /file/d/.../view ‡πÑ‡∏î‡πâ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥" required />
            </div>
          </div>

          <div style="display:flex;gap:10px;flex-wrap:wrap;">
            <button type="submit" class="submit-btn">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
            <button type="button" class="back-btn" id="cancelAddBtn" style="width:auto;padding:14px 40px;margin-top:0;">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          </div>
        </form>
      </div>

      <div class="controls-card">
        <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:15px;">
          <h3 style="color:#ff69b4;margin:0;">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
          <div style="display:flex;gap:10px;flex-wrap:wrap;">
            <button class="submit-btn" id="toggleAddFormBtn">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
            <button class="refresh-btn" id="refreshBtn">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏ï‡∏≤‡∏£‡∏≤‡∏á</button>
          </div>
        </div>
      </div>

      <div class="table-card">
        <table>
          <thead>
            <tr>
              <th>üñºÔ∏è ‡∏£‡∏π‡∏õ</th>
              <th>üè∑Ô∏è ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
              <th>üì¶ ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
              <th>üî¢ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
              <th>‚ú® ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
              <th>‚öôÔ∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
            </tr>
          </thead>
          <tbody id="adminTableBody">
            <tr>
              <td colspan="6" style="text-align:center;padding:40px;color:#999;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</td>
            </tr>
          </tbody>
        </table>

        <div id="lastUpdatedAdmin" class="last-updated"></div>
      </div>
    </div>
  </div>

  <!-- Image Modal -->
  <div class="modal" id="imageModal">
    <div class="modal-content">
      <img id="modalImage" src="" alt="Product Image" />
      <button class="modal-close" id="closeModal">‡∏õ‡∏¥‡∏î</button>
    </div>
  </div>

  <script>
    // --- Configs ---
    const ADMIN_ID = "3333333333*";
    const ADMIN_PASSWORD = "3333333333*";
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycby0ckKejlvrKls6RJm29MM2x2tgc7TK29qfYlKXT5K3bJ6AafchPkFsMRVc-wKcPLl-/exec";

    let allProducts = [];
    let currentFilter = "all";
    let lastUpdated = null;
    const ITEMS_PER_PAGE = 50;
    let currentViewerPage = 1;

    const PLACEHOLDER_IMAGE = 'data:image/svg+xml;utf8,' + encodeURIComponent(
      `<svg xmlns="http://www.w3.org/2000/svg" width="400" height="300"><rect fill="#ffe5f0" width="100%" height="100%"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#ff69b4" font-size="20">No Image</text></svg>`
    );

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text ?? '';
      return div.innerHTML;
    }

    function safeProduct(product) {
      const qRaw = product?.quantity;
      const qNum = Number(qRaw);
      const rawImage = product?.imageUrl ?? '';
      return {
        sku: product?.sku ?? "",
        name: product?.name ?? "",
        quantity: Number.isFinite(qNum) ? Math.floor(qNum) : 0,
        status: product?.status ?? "",
        imageUrl: normalizeImageUrl(rawImage)
      };
    }

    /**
     * normalizeImageUrl(url)
     * - ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Google Drive share links ‡∏´‡∏•‡∏≤‡∏Å‡∏´‡∏•‡∏≤‡∏¢ (file/d/, open?id=, uc?id=, /d/ID/view)
     * - ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ direct view URL (drive.google.com/uc?export=view&id=ID) ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Drive link
     * - ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô direct image URL / data URL / lh3
     */
    function normalizeImageUrl(url) {
      if (!url || typeof url !== 'string') return '';

      url = url.trim();

      // data image => return
      if (/^data:image\//i.test(url)) return url;

      // direct hosted image or lh3 => return
      if (/^https?:\/\/lh3\.googleusercontent\.com\//i.test(url)) return url;
      if (/\.(jpe?g|png|gif|webp|svg)(\?|$)/i.test(url)) return url;

      // common Google Drive patterns
      const patterns = [
        /\/file\/d\/([a-zA-Z0-9_-]{10,})/,          // /file/d/ID
        /[\?&]id=([a-zA-Z0-9_-]{10,})/,             // ?id=ID or &id=ID
        /\/d\/([a-zA-Z0-9_-]{10,})\/view/,          // /d/ID/view
        /drive\.google\.com\/uc\?id=([a-zA-Z0-9_-]{10,})/, // uc?id=ID
        /drive\.google\.com\/open\?id=([a-zA-Z0-9_-]{10,})/ // open?id=ID
      ];

      for (let i = 0; i < patterns.length; i++) {
        const m = url.match(patterns[i]);
        if (m && m[1]) {
          return 'https://drive.google.com/uc?export=view&id=' + m[1];
        }
      }

      // only ID supplied (>=20 chars)
      const maybeId = (url.match(/[a-zA-Z0-9_-]{20,}/) || [])[0];
      if (maybeId) {
        return 'https://drive.google.com/uc?export=view&id=' + maybeId;
      }

      // unknown -> return original (will fallback to placeholder if fails)
      return url;
    }

    function getStatusBadge(status) {
      const statusLower = (status || '').toLowerCase();
      let className = '';
      let emoji = '';
      let text = '';

      if (statusLower.includes('‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á')) {
        className = 'status-ready';
        emoji = '‚ú®';
        text = '‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á';
      } else if (statusLower.includes('‡∏´‡∏°‡∏î')) {
        className = 'status-out';
        emoji = '‚ö†Ô∏è';
        text = '‡∏´‡∏°‡∏î';
      } else if (statusLower.includes('‡πÇ‡∏Å‡∏î‡∏±‡∏á')) {
        className = 'status-warehouse';
        emoji = 'üì¶';
        text = '‡∏≠‡∏¢‡∏π‡πà‡πÇ‡∏Å‡∏î‡∏±‡∏á‡πÑ‡∏ó‡∏¢';
      } else if (statusLower.includes('‡∏à‡∏±‡∏î‡∏™‡πà‡∏á')) {
        className = 'status-shipping';
        emoji = 'üöö';
        text = '‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á';
      } else {
        className = 'status-ready';
        emoji = '‚ú®';
        text = status || '';
      }

      return `<span class="status-badge ${className}">${emoji} ${escapeHtml(text)}</span>`;
    }

    // JSONP loader
    function jsonpRequest(paramsObj) {
      const callbackName = 'jsonpCallback_' + Date.now() + '_' + Math.floor(Math.random()*1000);
      return new Promise((resolve, reject) => {
        window[callbackName] = function (response) {
          try {
            delete window[callbackName];
            if (scriptEl && scriptEl.parentNode) document.body.removeChild(scriptEl);
          } catch (e) {}
          if (response && response.ok) resolve(response);
          else reject(new Error(response?.msg || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå'));
        };
        const params = new URLSearchParams(Object.assign({}, paramsObj, { callback: callbackName }));
        const scriptEl = document.createElement('script');
        scriptEl.src = `${APPS_SCRIPT_URL}?${params.toString()}`;
        scriptEl.onerror = function() {
          try { delete window[callbackName]; } catch(e) {}
          if (scriptEl && scriptEl.parentNode) document.body.removeChild(scriptEl);
          reject(new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ'));
        };
        document.body.appendChild(scriptEl);
      });
    }

    // load products
    function loadProducts(callback) {
      Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...', allowOutsideClick:false, didOpen:()=>Swal.showLoading() });
      jsonpRequest({ action: 'list' })
        .then(res => {
          allProducts = (res.data || []).map(p => {
            const copy = Object.assign({}, p);
            copy.imageUrl = normalizeImageUrl(copy.imageUrl || '');
            return copy;
          });
          lastUpdated = new Date();
          Swal.close();
          if (typeof callback === 'function') callback();
        })
        .catch(err => {
          Swal.close();
          Swal.fire({ icon:'error', title:'‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', text: err.message || err });
        });
    }

    function updateLastUpdatedText() {
      if (!lastUpdated) return;
      const dateStr = lastUpdated.toLocaleString('th-TH', { day:'2-digit', month:'2-digit', year:'numeric' });
      const timeStr = lastUpdated.toLocaleString('th-TH', { hour:'2-digit', minute:'2-digit' });
      const displayText = `‚è∞ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î : ${dateStr} ‚Ä¢ ${timeStr} ‡∏ô.`;
      const viewerEl = document.getElementById('lastUpdatedViewer');
      const adminEl = document.getElementById('lastUpdatedAdmin');
      if (viewerEl) viewerEl.textContent = displayText;
      if (adminEl) adminEl.textContent = displayText;
    }

    // viewer render
    function filterAndRenderViewer() {
      const searchTerm = (document.getElementById('searchInput').value || '').toLowerCase();
      let filtered = allProducts.slice();

      if (currentFilter !== 'all') filtered = filtered.filter(p => (p.status || '') === currentFilter);

      if (searchTerm) {
        filtered = filtered.filter(p => {
          const safe = safeProduct(p);
          return safe.sku.toLowerCase().includes(searchTerm) || safe.name.toLowerCase().includes(searchTerm);
        });
      }

      const totalPages = Math.ceil(filtered.length / ITEMS_PER_PAGE);
      if (currentViewerPage > totalPages && totalPages > 0) currentViewerPage = 1;

      const start = (currentViewerPage - 1) * ITEMS_PER_PAGE;
      const pageData = filtered.slice(start, start + ITEMS_PER_PAGE);

      const tbody = document.getElementById('viewerTableBody');

      if (!filtered.length) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:40px;color:#999;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</td></tr>';
        updatePaginationControls(0,0);
        updateLastUpdatedText();
        return;
      }

      tbody.innerHTML = pageData.map(product => {
        const safe = safeProduct(product);
        const imageUrl = safe.imageUrl || '';
        const imgEsc = escapeHtml(imageUrl || '');
        return `
          <tr>
            <td>
              <img src="${imgEsc || PLACEHOLDER_IMAGE}"
                   alt="${escapeHtml(safe.name)}"
                   class="product-image"
                   data-image="${imgEsc}"
                   onerror="this.onerror=null;this.src='${PLACEHOLDER_IMAGE}';">
            </td>
            <td>${escapeHtml(safe.sku)}</td>
            <td>${escapeHtml(safe.name)}</td>
            <td>${escapeHtml(String(safe.quantity))}</td>
            <td>${getStatusBadge(safe.status)}</td>
          </tr>
        `;
      }).join('');

      updatePaginationControls(currentViewerPage, totalPages);
      updateLastUpdatedText();
    }

    function updatePaginationControls(currentPage, totalPages) {
      const paginationEl = document.getElementById('viewerPagination');
      if (!paginationEl) return;
      if (totalPages <= 1) { paginationEl.style.display = 'none'; return; }
      paginationEl.style.display = 'flex';
      document.getElementById('pageInfo').textContent = `‡∏´‡∏ô‡πâ‡∏≤ ${currentPage} / ${totalPages}`;
      document.getElementById('prevPageBtn').disabled = currentPage <= 1;
      document.getElementById('nextPageBtn').disabled = currentPage >= totalPages;
    }

    // admin render
    function renderAdminTable() {
      const tbody = document.getElementById('adminTableBody');
      if (!allProducts.length) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px;color:#999;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</td></tr>';
        updateLastUpdatedText();
        return;
      }
      tbody.innerHTML = allProducts.map(product => {
        const safe = safeProduct(product);
        const imgEsc = escapeHtml(safe.imageUrl || '');
        return `
          <tr>
            <td><img src="${imgEsc || PLACEHOLDER_IMAGE}" alt="${escapeHtml(safe.name)}" class="product-image" data-image="${imgEsc}" onerror="this.onerror=null;this.src='${PLACEHOLDER_IMAGE}';"></td>
            <td>${escapeHtml(safe.sku)}</td>
            <td>${escapeHtml(safe.name)}</td>
            <td>${escapeHtml(String(safe.quantity))}</td>
            <td>${getStatusBadge(safe.status)}</td>
            <td>
              <button class="action-btn edit-btn admin-action" data-action="edit" data-sku="${escapeHtml(safe.sku)}">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
              <button class="action-btn delete-btn admin-action" data-action="delete" data-sku="${escapeHtml(safe.sku)}">üóëÔ∏è ‡∏•‡∏ö</button>
            </td>
          </tr>
        `;
      }).join('');
      updateLastUpdatedText();
    }

    // image modal
    function openImageModal(imageUrl) {
      const img = (imageUrl || '').replace(/&amp;/g, '&');
      const modalImg = document.getElementById('modalImage');
      modalImg.src = img || PLACEHOLDER_IMAGE;
      modalImg.onerror = function(){ this.onerror=null; this.src=PLACEHOLDER_IMAGE; };
      document.getElementById('imageModal').classList.add('active');
    }

    // views
    function showViewer() {
      document.getElementById('viewerSection').style.display = 'block';
      document.getElementById('loginSection').style.display = 'none';
      document.getElementById('adminSection').style.display = 'none';
      loadProducts(filterAndRenderViewer);
    }
    function showLogin() {
      document.getElementById('viewerSection').style.display = 'none';
      document.getElementById('loginSection').style.display = 'flex';
      document.getElementById('adminSection').style.display = 'none';
    }
    function showAdmin() {
      document.getElementById('viewerSection').style.display = 'none';
      document.getElementById('loginSection').style.display = 'none';
      document.getElementById('adminSection').style.display = 'block';
      loadProducts(renderAdminTable);
    }

    function toggleAddForm() {
      const formCard = document.getElementById('addProductCard');
      const isVisible = formCard.style.display !== 'none';
      if (isVisible) {
        formCard.style.display = 'none';
        document.getElementById('addProductForm').reset();
      } else {
        formCard.style.display = 'block';
        formCard.scrollIntoView({ behavior:'smooth', block:'start' });
      }
    }

    // edit modal via Swal2
    function openEditModalForSku(sku) {
      const idx = allProducts.findIndex(p => String(p.sku) === String(sku));
      if (idx === -1) { Swal.fire({icon:'error',title:'‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤',text:'‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç'}); return; }
      const product = safeProduct(allProducts[idx]);

      Swal.fire({
        title: '‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤',
        width: 'min(520px, 96%)',
        html: `
          <div style="text-align:left; max-width:100%; margin:0 auto;">
            <div class="form-group"><label>‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label><input id="editSku" class="swal2-input" value="${escapeHtml(product.sku)}" readonly style="background:#f5f5f4;"></div>
            <div class="form-group"><label>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label><input id="editName" class="swal2-input" value="${escapeHtml(product.name)}"></div>
            <div class="form-group"><label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label><input id="editQuantity" class="swal2-input" type="number" min="0" step="1" value="${String(product.quantity)}"></div>
            <div class="form-group"><label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
              <select id="editStatus" class="swal2-select" style="display:block;width:100%;padding:12px;">
                <option value="‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á" ${product.status==='‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á'?'selected':''}>‚úÖ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á</option>
                <option value="‡∏´‡∏°‡∏î" ${product.status==='‡∏´‡∏°‡∏î'?'selected':''}>‚ö†Ô∏è ‡∏´‡∏°‡∏î</option>
                <option value="‡∏≠‡∏¢‡∏π‡πà‡πÇ‡∏Å‡∏î‡∏±‡∏á‡πÑ‡∏ó‡∏¢" ${product.status==='‡∏≠‡∏¢‡∏π‡πà‡πÇ‡∏Å‡∏î‡∏±‡∏á‡πÑ‡∏ó‡∏¢'?'selected':''}>üì¶ ‡∏≠‡∏¢‡∏π‡πà‡πÇ‡∏Å‡∏î‡∏±‡∏á‡πÑ‡∏ó‡∏¢</option>
                <option value="‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á" ${product.status==='‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á'?'selected':''}>üöö ‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</option>
              </select>
            </div>
            <div class="form-group"><label>‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ</label><input id="editImageUrl" class="swal2-input" value="${escapeHtml(product.imageUrl)}"></div>
          </div>
        `,
        showCancelButton: true,
        confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å',
        cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
        preConfirm: () => {
          const name = document.getElementById('editName').value.trim();
          const qtyRaw = document.getElementById('editQuantity').value;
          const quantity = Number(qtyRaw);
          const status = document.getElementById('editStatus').value;
          const raw = document.getElementById('editImageUrl').value.trim();
          const imageUrl = normalizeImageUrl(raw);

          if (!name || !status) { Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô'); return false; }
          if (!Number.isFinite(quantity) || quantity < 0 || !Number.isInteger(quantity)) { Swal.showValidationMessage('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ï‡πá‡∏°‡∏ö‡∏ß‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö 0'); return false; }
          if (!imageUrl) { Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); return false; }

          return { sku: product.sku, name, quantity, status, imageUrl, originalImageUrl: raw };
        }
      }).then((result) => {
        if (result.isConfirmed) updateProduct(result.value);
      });
    }

    function updateProduct(data) {
      Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...', allowOutsideClick:false, didOpen:()=>Swal.showLoading() });

      const params = {
        action: 'update',
        adminId: ADMIN_ID,
        adminPassword: ADMIN_PASSWORD,
        sku: data.sku,
        name: data.name,
        quantity: String(Math.floor(Number(data.quantity))),
        status: data.status,
        imageUrl: normalizeImageUrl(data.imageUrl),
        originalImageUrl: data.originalImageUrl || ''
      };

      jsonpRequest(params)
        .then(res => { Swal.close(); Swal.fire({icon:'success',title:'‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',text:'‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß'}); loadProducts(renderAdminTable); })
        .catch(err => { Swal.close(); Swal.fire({icon:'error',title:'‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',text: err.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ'}); });
    }

    function deleteProductBySku(sku) {
      Swal.fire({
        title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö',
        text: `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ${sku} ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: '‡∏•‡∏ö',
        cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
      }).then(result => {
        if (!result.isConfirmed) return;
        Swal.fire({ title:'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö', text:'‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...', allowOutsideClick:false, didOpen:()=>Swal.showLoading() });
        jsonpRequest({ action:'delete', adminId:ADMIN_ID, adminPassword:ADMIN_PASSWORD, sku })
          .then(res => { Swal.close(); Swal.fire({icon:'success',title:'‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',text:'‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß'}); loadProducts(renderAdminTable); })
          .catch(err => { Swal.close(); Swal.fire({icon:'error',title:'‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',text: err.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ'}); });
      });
    }

    // delegation (admin table & viewer table)
    function attachAdminTableHandlers() {
      const adminTbody = document.getElementById('adminTableBody');
      if (!adminTbody) return;

      adminTbody.addEventListener('click', function (ev) {
        const btn = ev.target.closest('.admin-action');
        if (btn) {
          const action = btn.getAttribute('data-action');
          const sku = btn.getAttribute('data-sku');
          if (action === 'edit') openEditModalForSku(sku);
          else if (action === 'delete') deleteProductBySku(sku);
          return;
        }
        const img = ev.target.closest('.product-image');
        if (img && img.dataset && img.dataset.image) openImageModal(img.dataset.image);
      });

      document.getElementById('viewerTableBody')?.addEventListener('click', function(ev) {
        const img = ev.target.closest('.product-image');
        if (img && img.dataset && img.dataset.image) openImageModal(img.dataset.image);
      });
    }

    function addProduct(data) {
      Swal.fire({ title:'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', text:'‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...', allowOutsideClick:false, didOpen:()=>Swal.showLoading() });
      const params = {
        action:'add',
        adminId:ADMIN_ID,
        adminPassword:ADMIN_PASSWORD,
        sku: data.sku,
        name: data.name,
        quantity: String(Math.floor(Number(data.quantity))),
        status: data.status,
        imageUrl: normalizeImageUrl(data.imageUrl),
        originalImageUrl: data.imageUrl || ''
      };
      jsonpRequest(params).then(res => { Swal.close(); Swal.fire({icon:'success',title:'‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',text:'‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß'}); document.getElementById('addProductForm').reset(); toggleAddForm(); loadProducts(renderAdminTable); })
        .catch(err => { Swal.close(); Swal.fire({icon:'error',title:'‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',text: err.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ'}); });
    }

    // event listeners
    document.getElementById('goToAdminBtn').addEventListener('click', showLogin);
    document.getElementById('backToViewerBtn').addEventListener('click', showViewer);

    document.getElementById('loginForm').addEventListener('submit', function(e){
      e.preventDefault();
      const adminId = document.getElementById('adminId').value;
      const adminPassword = document.getElementById('adminPassword').value;
      if (adminId === ADMIN_ID && adminPassword === ADMIN_PASSWORD) {
        sessionStorage.setItem('isAdminLoggedIn','true');
        showAdmin();
      } else Swal.fire({icon:'error',title:'‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',text:'Admin ID ‡∏´‡∏£‡∏∑‡∏≠ Password ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'});
    });

    document.getElementById('logoutBtn').addEventListener('click', function(){
      sessionStorage.removeItem('isAdminLoggedIn');
      document.getElementById('adminId').value = '';
      document.getElementById('adminPassword').value = '';
      showViewer();
    });

    document.getElementById('toggleAddFormBtn').addEventListener('click', toggleAddForm);
    document.getElementById('cancelAddBtn').addEventListener('click', toggleAddForm);

    document.getElementById('addProductForm').addEventListener('submit', function(e){
      e.preventDefault();
      const sku = document.getElementById('addSku').value.trim();
      const name = document.getElementById('addName').value.trim();
      const quantity = Number(document.getElementById('addQuantity').value);
      const status = document.getElementById('addStatus').value.trim();
      const raw = document.getElementById('addImageUrl').value.trim();
      const imageUrl = normalizeImageUrl(raw);

      if (!sku || !name) { Swal.fire({icon:'error',title:'‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö',text:'‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'}); return; }
      if (!Number.isFinite(quantity) || quantity < 0 || !Number.isInteger(quantity)) { Swal.fire({icon:'error',title:'‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á',text:'‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡∏∞‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö 0'}); return; }
      if (!imageUrl) { Swal.fire({icon:'error',title:'‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á',text:'‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô URL ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'}); return; }

      addProduct({ sku, name, quantity, status, imageUrl: raw });
    });

    document.getElementById('refreshBtn').addEventListener('click', function(){ loadProducts(renderAdminTable); });
    document.getElementById('searchInput').addEventListener('input', function(){ currentViewerPage = 1; filterAndRenderViewer(); });
    document.getElementById('statusFilterSelect').addEventListener('change', function(){ currentFilter = this.value; currentViewerPage = 1; filterAndRenderViewer(); });
    document.getElementById('prevPageBtn').addEventListener('click', function(){ if (currentViewerPage>1){ currentViewerPage--; filterAndRenderViewer(); }});
    document.getElementById('nextPageBtn').addEventListener('click', function(){ currentViewerPage++; filterAndRenderViewer(); });

    document.getElementById('closeModal').addEventListener('click', function(){ document.getElementById('imageModal').classList.remove('active'); });
    document.getElementById('imageModal').addEventListener('click', function(e){ if (e.target === this) this.classList.remove('active'); });

    // dark mode simple
    function updateThemeToggleButtons(isDark) {
      const buttons = [ document.getElementById('themeToggleViewer'), document.getElementById('themeToggleAdmin') ];
      buttons.forEach(btn => { if (!btn) return; const icon = btn.querySelector('.theme-icon'); const text = btn.querySelector('.theme-text'); if (isDark) { if (icon) icon.textContent='‚òÄÔ∏è'; if (text) text.textContent='Light'; } else { if (icon) icon.textContent='üåô'; if (text) text.textContent='Dark'; }});
    }
    function toggleDarkMode() { const body=document.body; const isDark = body.classList.toggle('dark-mode'); localStorage.setItem('themeMode', isDark ? 'dark' : 'light'); updateThemeToggleButtons(isDark); }
    function initTheme() { const saved = localStorage.getItem('themeMode'); if (saved==='dark'){ document.body.classList.add('dark-mode'); updateThemeToggleButtons(true); } else updateThemeToggleButtons(false); }
    initTheme();
    document.getElementById('themeToggleViewer')?.addEventListener('click', toggleDarkMode);
    document.getElementById('themeToggleAdmin')?.addEventListener('click', toggleDarkMode);

    // init
    attachAdminTableHandlers();
    if (sessionStorage.getItem('isAdminLoggedIn') === 'true') showAdmin(); else showViewer();

    // --- optional: test helper (‡πÉ‡∏ä‡πâ path ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö) ---
    // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á test path ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô environment ‡∏ô‡∏µ‡πâ (‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô URL ‡πÉ‡∏´‡πâ): '/mnt/data/9e63eccb-fc61-4338-b635-a49431d4d313.png'
    // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ó‡∏î‡∏™‡∏≠‡∏ö (‡πÄ‡∏õ‡∏¥‡∏î console ‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡∏≤‡∏á): 
    //   const img = document.createElement('img'); img.src = '/mnt/data/9e63eccb-fc61-4338-b635-a49431d4d313.png'; document.body.appendChild(img);
  </script>
</body>
</html>
