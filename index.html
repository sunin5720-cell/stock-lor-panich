<!doctype html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ - ‚≠ê ‡∏•‡πâ‡∏≠‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå ‚≠ê</title>

  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- Tailwind (‡∏≠‡∏≤‡∏à‡∏°‡∏µ/‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡πá‡πÑ‡∏î‡πâ) -->
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>

  <style>
    /* (‡∏ï‡∏±‡∏î CSS ‡∏¢‡∏≤‡∏ß ‡πÜ ‡∏≠‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö ‚Äî ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏´‡πâ‡∏ß‡∏≤‡∏á CSS ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) */
    /* ‡πÉ‡∏ä‡πâ CSS ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì */
    /* ... (‡∏ß‡∏≤‡∏á CSS ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö) ... */
    /* ---------- */
    /* ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ß‡πà‡∏≤‡∏¢‡∏±‡∏á‡∏Ñ‡∏á CSS ‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö */
  </style>
</head>
<body>
  <!-- (HTML ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° ‚Äî ‡∏ú‡∏°‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô) -->
  <!-- Viewer Section -->
  <div id="viewerSection">
    <div class="container">
      <div class="header">
        <button class="theme-toggle-btn" id="themeToggleViewer" aria-label="Toggle Dark Mode">
          <span class="theme-icon">üåô</span>
          <span class="theme-text">Dark</span>
        </button>
        <h1 id="pageTitle">‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡∏π‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h1>
        <div class="shop-badge" id="shopName">‚≠ê ‡∏•‡πâ‡∏≠‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå ‚≠ê</div>
        <div>
          <button class="admin-btn" id="goToAdminBtn">
            <svg xmlns="http://www.w3.org/2000/svg"
                 width="18" height="18"
                 viewBox="0 0 24 24"
                 fill="none"
                 stroke="currentColor"
                 stroke-width="2"
                 stroke-linecap="round"
                 stroke-linejoin="round"
                 style="display:inline-block;vertical-align:middle;margin-right:8px;">
              <rect x="3" y="11" width="18" height="11" rx="2" ry="2" />
              <path d="M7 11V7a5 5 0 0 1 10 0v4" />
            </svg>
            <span style="display:inline-block;vertical-align:middle;">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Admin</span>
          </button>
          <p class="header-subtitle">‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
        </div>
      </div>

      <div class="controls-card">
        <div class="search-filter-row">
          <div class="search-box">
            <input type="text" id="searchInput" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤..." />
          </div>
          <div class="filter-group">
            <select class="filter-select" id="statusFilterSelect">
              <option value="all">üìã ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
              <option value="‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á">‚úÖ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á</option>
              <option value="‡∏´‡∏°‡∏î">‚ö†Ô∏è ‡∏´‡∏°‡∏î</option>
              <option value="‡∏≠‡∏¢‡∏π‡πà‡πÇ‡∏Å‡∏î‡∏±‡∏á‡πÑ‡∏ó‡∏¢">üì¶ ‡∏≠‡∏¢‡∏π‡πà‡πÇ‡∏Å‡∏î‡∏±‡∏á‡πÑ‡∏ó‡∏¢</option>
              <option value="‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á">üöö ‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</option>
            </select>
          </div>
        </div>
      </div>

      <div class="table-card">
        <table>
          <thead>
            <tr>
              <th>üñºÔ∏è ‡∏£‡∏π‡∏õ</th>
              <th>üè∑Ô∏è ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
              <th>üì¶ ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
              <th>üî¢ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
              <th>‚ú® ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
            </tr>
          </thead>
          <tbody id="viewerTableBody">
            <tr>
              <td colspan="5" style="text-align:center;padding:40px;color:#999;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td>
            </tr>
          </tbody>
        </table>

        <div id="viewerPagination"
             style="display:none;justify-content:center;align-items:center;gap:15px;margin-top:20px;padding-top:20px;border-top:2px solid #ffe5f0;">
          <button id="prevPageBtn" class="action-btn edit-btn" style="margin:0;">‚óÄ ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
          <span id="pageInfo" style="color:#ff69b4;font-weight:600;font-size:16px;">‡∏´‡∏ô‡πâ‡∏≤ 1 / 1</span>
          <button id="nextPageBtn" class="action-btn edit-btn" style="margin:0;">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚ñ∂</button>
        </div>

        <div id="lastUpdatedViewer" class="last-updated"></div>
      </div>
    </div>
  </div>

  <!-- Login Section -->
  <div class="login-container" id="loginSection">
    <div class="login-card">
      <h2>üîê ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Admin</h2>
      <form id="loginForm">
        <div class="form-group">
          <label for="adminId">Admin ID</label>
          <input type="text" id="adminId" required />
        </div>
        <div class="form-group">
          <label for="adminPassword">Password</label>
          <input type="password" id="adminPassword" required />
        </div>
        <button type="submit" class="login-btn">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        <button type="button" class="back-btn" id="backToViewerBtn">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
      </form>
    </div>
  </div>

  <!-- Admin Section -->
  <div class="admin-container" id="adminSection" style="display:none;">
    <div class="container">
      <div class="header">
        <button class="theme-toggle-btn" id="themeToggleAdmin" aria-label="Toggle Dark Mode">
          <span class="theme-icon">üåô</span>
          <span class="theme-text">Dark</span>
        </button>

        <div class="admin-header" style="display:flex;width:100%;justify-content:space-between;align-items:center;">
          <div>
            <h1 id="adminPageTitle">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h1>
            <div class="shop-badge" id="adminShopName">‚≠ê ‡∏•‡πâ‡∏≠‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå ‚≠ê</div>
          </div>
          <button class="logout-btn" id="logoutBtn">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
      </div>

      <div class="form-card" id="addProductCard" style="display:none;">
        <h3>‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</h3>
        <form id="addProductForm">
          <div class="form-row">
            <div class="form-group">
              <label for="addSku">‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ *</label>
              <input type="text" id="addSku" required />
            </div>
            <div class="form-group">
              <label for="addName">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ *</label>
              <input type="text" id="addName" required />
            </div>
            <div class="form-group">
              <label for="addQuantity">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ *</label>
              <input type="number" id="addQuantity" min="0" value="0" required />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="addStatus">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ *</label>
              <select id="addStatus" required>
                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ --</option>
                <option value="‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á">‚úÖ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á</option>
                <option value="‡∏´‡∏°‡∏î">‚ö†Ô∏è ‡∏´‡∏°‡∏î</option>
                <option value="‡∏≠‡∏¢‡∏π‡πà‡πÇ‡∏Å‡∏î‡∏±‡∏á‡πÑ‡∏ó‡∏¢">üì¶ ‡∏≠‡∏¢‡∏π‡πà‡πÇ‡∏Å‡∏î‡∏±‡∏á‡πÑ‡∏ó‡∏¢</option>
                <option value="‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á">üöö ‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</option>
              </select>
            </div>
            <div class="form-group">
              <label for="addImageUrl">‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ *</label>
              <input type="url" id="addImageUrl"
                     placeholder="‡∏ß‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå Google Drive ‡πÅ‡∏ö‡∏ö /file/d/.../view ‡πÑ‡∏î‡πâ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥"
                     required />
            </div>
          </div>

          <div style="display:flex;gap:10px;flex-wrap:wrap;">
            <button type="submit" class="submit-btn">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
            <button type="button" class="back-btn" id="cancelAddBtn"
                    style="width:auto;padding:14px 40px;margin-top:0;">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          </div>
        </form>
      </div>

      <div class="controls-card">
        <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:15px;">
          <h3 style="color:#ff69b4;margin:0;">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
          <div style="display:flex;gap:10px;flex-wrap:wrap;">
            <button class="submit-btn" id="toggleAddFormBtn">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
            <button class="refresh-btn" id="refreshBtn">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏ï‡∏≤‡∏£‡∏≤‡∏á</button>
          </div>
        </div>
      </div>

      <div class="table-card">
        <table>
          <thead>
            <tr>
              <th>üñºÔ∏è ‡∏£‡∏π‡∏õ</th>
              <th>üè∑Ô∏è ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
              <th>üì¶ ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
              <th>üî¢ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
              <th>‚ú® ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
              <th>‚öôÔ∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
            </tr>
          </thead>
          <tbody id="adminTableBody">
            <tr>
              <td colspan="6" style="text-align:center;padding:40px;color:#999;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</td>
            </tr>
          </tbody>
        </table>

        <div id="lastUpdatedAdmin" class="last-updated"></div>
      </div>
    </div>
  </div>

  <!-- Image Modal -->
  <div class="modal" id="imageModal">
    <div class="modal-content">
      <img id="modalImage" src="" alt="Product Image" />
      <button class="modal-close" id="closeModal">‡∏õ‡∏¥‡∏î</button>
    </div>
  </div>

  <script>
    // --- Configs ---
    const defaultConfig = {
      page_title: "‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡∏π‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤",
      shop_name: "‡∏•‡πâ‡∏≠‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå"
    };

    // *** ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™ admin ‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ***
    const ADMIN_ID = "3333333333*";
    const ADMIN_PASSWORD = "3333333333*";

    // URL Google Apps Script (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á) ‚Äî ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ URL ‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxzN1MfxYF9kGIC5HYGZ33ZSMfx4oCGoeMjsNoGzZZ2xAzGnXNqTuv0Ab5LsSaKh9tn/exec";

    let allProducts = [];
    let currentFilter = "all";
    let lastUpdated = null;
    const ITEMS_PER_PAGE = 50;
    let currentViewerPage = 1;

    // --- Helpers ---
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text ?? '';
      return div.innerHTML;
    }

    function safeProduct(product) {
      // ‡πÅ‡∏õ‡∏•‡∏á quantity ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏™‡∏°‡∏≠ (integer) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á bug ‡∏ï‡∏≠‡∏ô‡πÅ‡∏Å‡πâ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô
      const qRaw = product?.quantity;
      const qNum = Number(qRaw);
      return {
        sku: product?.sku ?? "",
        name: product?.name ?? "",
        // ‡∏´‡∏≤‡∏Å qRaw ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç ‡∏à‡∏∞‡πÑ‡∏î‡πâ 0
        quantity: Number.isFinite(qNum) ? Math.floor(qNum) : 0,
        status: product?.status ?? "",
        imageUrl: product?.imageUrl ?? ""
      };
    }

    function normalizeImageUrl(url) {
      if (!url || typeof url !== 'string') return url;
      const drivePattern = /drive\.google\.com\/file\/d\/([a-zA-Z0-9_-]+)/;
      const match = url.match(drivePattern);
      if (match && match[1]) {
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á direct link ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ (UC format) ‚Äî ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ lh3 ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏°
        return `https://drive.google.com/uc?export=view&id=${match[1]}`;
      }
      return url;
    }

    function getStatusBadge(status) {
      const statusLower = (status || '').toLowerCase();
      let className = '';
      let emoji = '';
      let text = '';

      if (statusLower.includes('‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á')) {
        className = 'status-ready';
        emoji = '‚ú®';
        text = '‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á';
      } else if (statusLower.includes('‡∏´‡∏°‡∏î')) {
        className = 'status-out';
        emoji = '‚ö†Ô∏è';
        text = '‡∏´‡∏°‡∏î';
      } else if (statusLower.includes('‡πÇ‡∏Å‡∏î‡∏±‡∏á')) {
        className = 'status-warehouse';
        emoji = 'üì¶';
        text = '‡∏≠‡∏¢‡∏π‡πà‡πÇ‡∏Å‡∏î‡∏±‡∏á‡πÑ‡∏ó‡∏¢';
      } else if (statusLower.includes('‡∏à‡∏±‡∏î‡∏™‡πà‡∏á')) {
        className = 'status-shipping';
        emoji = 'üöö';
        text = '‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á';
      } else {
        className = 'status-ready';
        emoji = '‚ú®';
        text = status || '';
      }

      return `<span class="status-badge ${className}">${emoji} ${escapeHtml(text)}</span>`;
    }

    // --- JSONP loader (reusable) ---
    function jsonpRequest(paramsObj, onSuccess, onError) {
      const callbackName = 'jsonpCallback_' + Date.now() + '_' + Math.floor(Math.random()*1000);
      return new Promise((resolve, reject) => {
        window[callbackName] = function (response) {
          try {
            delete window[callbackName];
            if (scriptEl && scriptEl.parentNode) document.body.removeChild(scriptEl);
          } catch (e) { /* ignore */ }

          if (response && response.ok) {
            resolve(response);
            if (typeof onSuccess === 'function') onSuccess(response);
          } else {
            const err = new Error(response?.msg || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå');
            reject(err);
            if (typeof onError === 'function') onError(err);
          }
        };

        const params = new URLSearchParams(Object.assign({}, paramsObj, { callback: callbackName }));
        const scriptEl = document.createElement('script');
        scriptEl.src = `${APPS_SCRIPT_URL}?${params.toString()}`;
        scriptEl.onerror = function () {
          try { delete window[callbackName]; } catch(e){ }
          if (scriptEl && scriptEl.parentNode) document.body.removeChild(scriptEl);
          const err = new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ');
          reject(err);
          if (typeof onError === 'function') onError(err);
        };
        document.body.appendChild(scriptEl);
      });
    }

    // --- Load products ---
    function loadProducts(callback) {
      Swal.fire({
        title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
        text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...',
        allowOutsideClick: false,
        didOpen: () => Swal.showLoading()
      });

      jsonpRequest({ action: 'list' })
        .then(res => {
          allProducts = (res.data || []).map(p => {
            // ‡πÄ‡∏Å‡πá‡∏ö raw object ‡πÅ‡∏ï‡πà‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤ quantity ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÉ‡∏ô safeProduct
            return p;
          });
          lastUpdated = new Date();
          Swal.close();
          if (typeof callback === 'function') callback();
        })
        .catch(err => {
          Swal.close();
          Swal.fire({ icon: 'error', title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', text: err.message || err, confirmButtonColor: '#ff69b4' });
        });
    }

    function updateLastUpdatedText() {
      if (!lastUpdated) return;

      const dateStr = lastUpdated.toLocaleString('th-TH', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
      });

      const timeStr = lastUpdated.toLocaleString('th-TH', {
        hour: '2-digit',
        minute: '2-digit'
      });

      const displayText = `‚è∞ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î : ${dateStr} ‚Ä¢ ${timeStr} ‡∏ô.`;

      const viewerEl = document.getElementById('lastUpdatedViewer');
      const adminEl = document.getElementById('lastUpdatedAdmin');

      if (viewerEl) viewerEl.textContent = displayText;
      if (adminEl) adminEl.textContent = displayText;
    }

    // --- Viewer rendering & pagination ---
    function filterAndRenderViewer() {
      const searchTerm = (document.getElementById('searchInput').value || '').toLowerCase();
      let filtered = allProducts.slice();

      if (currentFilter !== 'all') {
        filtered = filtered.filter(p => (p.status || '') === currentFilter);
      }

      if (searchTerm) {
        filtered = filtered.filter(p => {
          const safe = safeProduct(p);
          return safe.sku.toLowerCase().includes(searchTerm) ||
                 safe.name.toLowerCase().includes(searchTerm);
        });
      }

      const totalPages = Math.ceil(filtered.length / ITEMS_PER_PAGE);
      if (currentViewerPage > totalPages && totalPages > 0) {
        currentViewerPage = 1;
      }

      const start = (currentViewerPage - 1) * ITEMS_PER_PAGE;
      const end = start + ITEMS_PER_PAGE;
      const pageData = filtered.slice(start, end);

      const tbody = document.getElementById('viewerTableBody');

      if (!filtered.length) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:40px;color:#999;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</td></tr>';
        updatePaginationControls(0, 0);
        updateLastUpdatedText();
        return;
      }

      tbody.innerHTML = pageData.map(product => {
        const safe = safeProduct(product);
        const imageUrl = normalizeImageUrl(safe.imageUrl);
        const imgEsc = escapeHtml(imageUrl);
        return `
          <tr>
            <td>
              <img src="${imgEsc}" alt="${escapeHtml(safe.name)}"
                   class="product-image" style="cursor:pointer;" data-image="${imgEsc}">
            </td>
            <td>${escapeHtml(safe.sku)}</td>
            <td>${escapeHtml(safe.name)}</td>
            <td>${escapeHtml(String(safe.quantity))}</td>
            <td>${getStatusBadge(safe.status)}</td>
          </tr>
        `;
      }).join('');

      updatePaginationControls(currentViewerPage, totalPages);
      updateLastUpdatedText();
    }

    function updatePaginationControls(currentPage, totalPages) {
      const paginationEl = document.getElementById('viewerPagination');
      if (!paginationEl) return;

      if (totalPages <= 1) {
        paginationEl.style.display = 'none';
        return;
      }

      paginationEl.style.display = 'flex';
      document.getElementById('pageInfo').textContent = `‡∏´‡∏ô‡πâ‡∏≤ ${currentPage} / ${totalPages}`;
      document.getElementById('prevPageBtn').disabled = currentPage <= 1;
      document.getElementById('nextPageBtn').disabled = currentPage >= totalPages;
    }

    // --- Admin table rendering (no inline onclick) ---
    function renderAdminTable() {
      const tbody = document.getElementById('adminTableBody');
      if (!allProducts.length) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px;color:#999;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</td></tr>';
        updateLastUpdatedText();
        return;
      }

      tbody.innerHTML = allProducts.map((product) => {
        const safe = safeProduct(product);
        const imageUrl = normalizeImageUrl(safe.imageUrl);
        const imgEsc = escapeHtml(imageUrl);
        // ‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏∞‡∏°‡∏µ data-sku ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ event delegation ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£
        return `
          <tr>
            <td><img src="${imgEsc}" alt="${escapeHtml(safe.name)}" class="product-image" style="cursor:pointer;" data-image="${imgEsc}"></td>
            <td>${escapeHtml(safe.sku)}</td>
            <td>${escapeHtml(safe.name)}</td>
            <td>${escapeHtml(String(safe.quantity))}</td>
            <td>${getStatusBadge(safe.status)}</td>
            <td>
              <button class="action-btn edit-btn admin-action" data-action="edit" data-sku="${escapeHtml(safe.sku)}">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
              <button class="action-btn delete-btn admin-action" data-action="delete" data-sku="${escapeHtml(safe.sku)}">üóëÔ∏è ‡∏•‡∏ö</button>
            </td>
          </tr>
        `;
      }).join('');

      updateLastUpdatedText();
    }

    // --- Image modal open (‡πÉ‡∏ä‡πâ delegation ‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô) ---
    function openImageModal(imageUrl) {
      const img = (imageUrl || '').replace(/&amp;/g, '&');
      document.getElementById('modalImage').src = img;
      document.getElementById('imageModal').classList.add('active');
    }

    // --- Navigation views ---
    function showViewer() {
      document.getElementById('viewerSection').style.display = 'block';
      document.getElementById('loginSection').style.display = 'none';
      document.getElementById('adminSection').style.display = 'none';
      loadProducts(filterAndRenderViewer);
    }

    function showLogin() {
      document.getElementById('viewerSection').style.display = 'none';
      document.getElementById('loginSection').style.display = 'flex';
      document.getElementById('adminSection').style.display = 'none';
    }

    function showAdmin() {
      document.getElementById('viewerSection').style.display = 'none';
      document.getElementById('loginSection').style.display = 'none';
      document.getElementById('adminSection').style.display = 'block';
      loadProducts(renderAdminTable);
    }

    function toggleAddForm() {
      const formCard = document.getElementById('addProductCard');
      const isVisible = formCard.style.display !== 'none';
      if (isVisible) {
        formCard.style.display = 'none';
        document.getElementById('addProductForm').reset();
      } else {
        formCard.style.display = 'block';
        formCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }

    // --- Edit product flow (‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ sku ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏£‡∏∞‡∏ö‡∏∏) ---
    function openEditModalForSku(sku) {
      const idx = allProducts.findIndex(p => String(p.sku) === String(sku));
      if (idx === -1) {
        Swal.fire({ icon: 'error', title: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', text: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç', confirmButtonColor: '#ff69b4' });
        return;
      }
      const product = safeProduct(allProducts[idx]);

      Swal.fire({
        title: '‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤',
        width: 'min(520px, 96%)',
        html: `
          <div style="text-align:left; max-width:100%; margin:0 auto;">
            <div class="form-group">
              <label>‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
              <input id="editSku" class="swal2-input" value="${escapeHtml(product.sku)}" readonly style="background:#f5f5f5;">
            </div>
            <div class="form-group">
              <label>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
              <input id="editName" class="swal2-input" value="${escapeHtml(product.name)}">
            </div>
            <div class="form-group">
              <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
              <input id="editQuantity" class="swal2-input" type="number" min="0" step="1" value="${String(product.quantity)}">
            </div>
            <div class="form-group">
              <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
              <select id="editStatus" class="swal2-select" style="display:block;width:100%;padding:12px;border:1px solid #d9d9d9;border-radius:5px;font-size:16px;background:white;cursor:pointer;margin-top:5px;">
                <option value="‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á" ${product.status === '‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á' ? 'selected' : ''}>‚úÖ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á</option>
                <option value="‡∏´‡∏°‡∏î" ${product.status === '‡∏´‡∏°‡∏î' ? 'selected' : ''}>‚ö†Ô∏è ‡∏´‡∏°‡∏î</option>
                <option value="‡∏≠‡∏¢‡∏π‡πà‡πÇ‡∏Å‡∏î‡∏±‡∏á‡πÑ‡∏ó‡∏¢" ${product.status === '‡∏≠‡∏¢‡∏π‡πà‡πÇ‡∏Å‡∏î‡∏±‡∏á‡πÑ‡∏ó‡∏¢' ? 'selected' : ''}>üì¶ ‡∏≠‡∏¢‡∏π‡πà‡πÇ‡∏Å‡∏î‡∏±‡∏á‡πÑ‡∏ó‡∏¢</option>
                <option value="‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á" ${product.status === '‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á' ? 'selected' : ''}>üöö ‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</option>
              </select>
            </div>
            <div class="form-group">
              <label>‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ</label>
              <input id="editImageUrl" class="swal2-input" value="${escapeHtml(product.imageUrl)}">
            </div>
          </div>
        `,
        showCancelButton: true,
        confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å',
        cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
        confirmButtonColor: '#ff69b4',
        preConfirm: () => {
          const name = document.getElementById('editName').value.trim();
          const qtyRaw = document.getElementById('editQuantity').value;
          const quantity = Number(qtyRaw);
          const status = document.getElementById('editStatus').value;
          const raw = document.getElementById('editImageUrl').value.trim();
          const imageUrl = normalizeImageUrl(raw);

          if (!name || !status) {
            Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
            return false;
          }
          if (!Number.isFinite(quantity) || quantity < 0 || !Number.isInteger(quantity)) {
            Swal.showValidationMessage('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ï‡πá‡∏°‡∏ö‡∏ß‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö 0');
            return false;
          }
          if (!imageUrl || !imageUrl.startsWith('http')) {
            Swal.showValidationMessage('‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô URL ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
            return false;
          }

          return { sku: product.sku, name, quantity, status, imageUrl };
        }
      }).then((result) => {
        if (result.isConfirmed) {
          updateProduct(result.value);
        }
      });
    }

    // --- Update product (‡∏™‡πà‡∏á quantity ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô) ---
    function updateProduct(data) {
      Swal.fire({
        title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï',
        text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...',
        allowOutsideClick: false,
        didOpen: () => Swal.showLoading()
      });

      const params = {
        action: 'update',
        adminId: ADMIN_ID,
        adminPassword: ADMIN_PASSWORD,
        sku: data.sku,
        name: data.name,
        // ‡∏™‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô integer ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
        quantity: String(Math.floor(Number(data.quantity))),
        status: data.status,
        imageUrl: data.imageUrl
      };

      jsonpRequest(params)
        .then(res => {
          Swal.close();
          Swal.fire({ icon: 'success', title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text: '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', confirmButtonColor: '#ff69b4' });
          // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á admin
          loadProducts(renderAdminTable);
        })
        .catch(err => {
          Swal.close();
          Swal.fire({ icon: 'error', title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', text: err.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ', confirmButtonColor: '#ff69b4' });
        });
    }

    // --- Delete product (‡πÉ‡∏ä‡πâ SKU ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏£‡∏∞‡∏ö‡∏∏) ---
    function deleteProductBySku(sku) {
      Swal.fire({
        title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö',
        text: `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ${sku} ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc3545',
        cancelButtonColor: '#6c757d',
        confirmButtonText: '‡∏•‡∏ö',
        cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
      }).then((result) => {
        if (!result.isConfirmed) return;

        Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

        jsonpRequest({
          action: 'delete',
          adminId: ADMIN_ID,
          adminPassword: ADMIN_PASSWORD,
          sku: sku
        }).then(res => {
          Swal.close();
          Swal.fire({ icon: 'success', title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text: '‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', confirmButtonColor: '#ff69b4' });
          loadProducts(renderAdminTable);
        }).catch(err => {
          Swal.close();
          Swal.fire({ icon: 'error', title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', text: err.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ', confirmButtonColor: '#ff69b4' });
        });
      });
    }

    // --- Event delegation for admin table (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç / ‡∏•‡∏ö / ‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏π‡∏õ) ---
    function attachAdminTableHandlers() {
      const adminTbody = document.getElementById('adminTableBody');
      if (!adminTbody) return;

      adminTbody.addEventListener('click', function (ev) {
        const btn = ev.target.closest('.admin-action');
        if (btn) {
          const action = btn.getAttribute('data-action');
          const sku = btn.getAttribute('data-sku');
          if (action === 'edit') {
            openEditModalForSku(sku);
          } else if (action === 'delete') {
            deleteProductBySku(sku);
          }
          return;
        }

        // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏£‡∏π‡∏õ‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡∏ó‡∏±‡πâ‡∏á admin & viewer) ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î modal
        const img = ev.target.closest('.product-image');
        if (img && img.dataset && img.dataset.image) {
          openImageModal(img.dataset.image);
        }
      });

      // viewer table image click (delegation)
      document.getElementById('viewerTableBody')?.addEventListener('click', function(ev) {
        const img = ev.target.closest('.product-image');
        if (img && img.dataset && img.dataset.image) {
          openImageModal(img.dataset.image);
        }
      });
    }

    // --- Add product (admin) ---
    function addProduct(data) {
      Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

      const params = {
        action: 'add',
        adminId: ADMIN_ID,
        adminPassword: ADMIN_PASSWORD,
        sku: data.sku,
        name: data.name,
        quantity: String(Math.floor(Number(data.quantity))),
        status: data.status,
        imageUrl: data.imageUrl
      };

      jsonpRequest(params).then(res => {
        Swal.close();
        Swal.fire({ icon: 'success', title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', confirmButtonColor: '#ff69b4' });
        document.getElementById('addProductForm').reset();
        toggleAddForm();
        loadProducts(renderAdminTable);
      }).catch(err => {
        Swal.close();
        Swal.fire({ icon: 'error', title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', text: err.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ', confirmButtonColor: '#ff69b4' });
      });
    }

    // --- Event Listeners (‡∏´‡∏ô‡πâ‡∏≤ UI) ---
    document.getElementById('goToAdminBtn').addEventListener('click', showLogin);
    document.getElementById('backToViewerBtn').addEventListener('click', showViewer);

    document.getElementById('loginForm').addEventListener('submit', function (e) {
      e.preventDefault();
      const adminId = document.getElementById('adminId').value;
      const adminPassword = document.getElementById('adminPassword').value;

      if (adminId === ADMIN_ID && adminPassword === ADMIN_PASSWORD) {
        sessionStorage.setItem('isAdminLoggedIn', 'true');
        showAdmin();
      } else {
        Swal.fire({ icon: 'error', title: '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text: 'Admin ID ‡∏´‡∏£‡∏∑‡∏≠ Password ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', confirmButtonColor: '#ff69b4' });
      }
    });

    document.getElementById('logoutBtn').addEventListener('click', function () {
      sessionStorage.removeItem('isAdminLoggedIn');
      document.getElementById('adminId').value = '';
      document.getElementById('adminPassword').value = '';
      showViewer();
    });

    document.getElementById('toggleAddFormBtn').addEventListener('click', toggleAddForm);
    document.getElementById('cancelAddBtn').addEventListener('click', toggleAddForm);

    document.getElementById('addProductForm').addEventListener('submit', function (e) {
      e.preventDefault();
      const sku = document.getElementById('addSku').value.trim();
      const name = document.getElementById('addName').value.trim();
      const quantity = Number(document.getElementById('addQuantity').value);
      const status = document.getElementById('addStatus').value.trim();
      const raw = document.getElementById('addImageUrl').value.trim();
      const imageUrl = normalizeImageUrl(raw);

      if (!sku || !name) {
        Swal.fire({ icon: 'error', title: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', confirmButtonColor: '#ff69b4' });
        return;
      }
      if (!Number.isFinite(quantity) || quantity < 0 || !Number.isInteger(quantity)) {
        Swal.fire({ icon: 'error', title: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', text: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡∏∞‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö 0', confirmButtonColor: '#ff69b4' });
        return;
      }
      if (!imageUrl || !imageUrl.startsWith('http')) {
        Swal.fire({ icon: 'error', title: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', text: '‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô URL ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', confirmButtonColor: '#ff69b4' });
        return;
      }

      addProduct({ sku, name, quantity, status, imageUrl });
    });

    document.getElementById('refreshBtn').addEventListener('click', function () {
      loadProducts(renderAdminTable);
    });

    document.getElementById('searchInput').addEventListener('input', function () {
      currentViewerPage = 1;
      filterAndRenderViewer();
    });

    document.getElementById('statusFilterSelect').addEventListener('change', function () {
      currentFilter = this.value;
      currentViewerPage = 1;
      filterAndRenderViewer();
    });

    document.getElementById('prevPageBtn').addEventListener('click', function () {
      if (currentViewerPage > 1) {
        currentViewerPage--;
        filterAndRenderViewer();
      }
    });

    document.getElementById('nextPageBtn').addEventListener('click', function () {
      currentViewerPage++;
      filterAndRenderViewer();
    });

    document.getElementById('closeModal').addEventListener('click', function () {
      document.getElementById('imageModal').classList.remove('active');
    });

    document.getElementById('imageModal').addEventListener('click', function (e) {
      if (e.target === this) {
        this.classList.remove('active');
      }
    });

    // --- Canva config (‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ) ---
    async function onConfigChange(config) {
      const pageTitle = config.page_title || defaultConfig.page_title;
      const shopName = config.shop_name || defaultConfig.shop_name;

      const pageTitleEl = document.getElementById('pageTitle');
      const shopNameEl = document.getElementById('shopName');
      const adminPageTitleEl = document.getElementById('adminPageTitle');
      const adminShopNameEl = document.getElementById('adminShopName');

      if (pageTitleEl) pageTitleEl.textContent = pageTitle;
      if (shopNameEl) shopNameEl.innerHTML = '‚≠ê ' + shopName + ' ‚≠ê';
      if (adminPageTitleEl) adminPageTitleEl.textContent = pageTitle;
      if (adminShopNameEl) adminShopNameEl.innerHTML = '‚≠ê ' + shopName + ' ‚≠ê';
    }

    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig: defaultConfig,
        onConfigChange: onConfigChange,
      });
    }

    // --- Dark Mode (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ---
    function updateThemeToggleButtons(isDark) {
      const buttons = [ document.getElementById('themeToggleViewer'), document.getElementById('themeToggleAdmin') ];
      buttons.forEach(btn => {
        if (!btn) return;
        const icon = btn.querySelector('.theme-icon');
        const text = btn.querySelector('.theme-text');
        if (isDark) { if (icon) icon.textContent = '‚òÄÔ∏è'; if (text) text.textContent = 'Light'; }
        else { if (icon) icon.textContent = 'üåô'; if (text) text.textContent = 'Dark'; }
      });
    }

    function toggleDarkMode() {
      const body = document.body;
      const isDark = body.classList.toggle('dark-mode');
      localStorage.setItem('themeMode', isDark ? 'dark' : 'light');
      updateThemeToggleButtons(isDark);
    }

    function initTheme() {
      const savedTheme = localStorage.getItem('themeMode');
      const body = document.body;
      if (savedTheme === 'dark') { body.classList.add('dark-mode'); updateThemeToggleButtons(true); }
      else { body.classList.remove('dark-mode'); updateThemeToggleButtons(false); }
    }

    initTheme();
    document.getElementById('themeToggleViewer')?.addEventListener('click', toggleDarkMode);
    document.getElementById('themeToggleAdmin')?.addEventListener('click', toggleDarkMode);

    // --- Init ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å ---
    attachAdminTableHandlers();

    if (sessionStorage.getItem('isAdminLoggedIn') === 'true') {
      showAdmin();
    } else {
      showViewer();
    }

  </script>
</body>
</html>
